<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Super Sick Bike Fundraiser</title>
    <!-- Use Tailwind CSS for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the Inter font for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main container for the GoFundMe-like page -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden max-w-2xl w-full p-8 space-y-8">

        <!-- Campaign Header -->
        <div class="text-center space-y-4">
            <h1 class="text-4xl font-bold text-gray-800">Help Fund The Super Sick Bike!</h1>
        </div>

        <!-- Campaign Image -->
        <div class="rounded-lg overflow-hidden shadow-lg">
            <!-- Updated image URL from the user's provided link -->
            <img src="https://i.imgur.com/clsLfk1.png" alt="The Super Sick Bike" class="w-full h-auto object-cover">
        </div>

        <!-- Donation Progress Section -->
        <div class="space-y-4">
            <div class="flex justify-between items-center text-lg font-semibold text-gray-700">
                <span id="current-amount">$0</span>
                <span id="goal-amount">goal of $5,000</span>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-yellow-500 h-3 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>

            <div class="text-sm text-gray-500">
                <span id="total-donations">0</span> donations
            </div>
        </div>

        <!-- Campaign Story Section -->
        <div class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Our Mission</h2>
            <p class="text-gray-600 leading-relaxed">
                Our mission began at Rosalie Primary School where we created a prototype for the Super Sick Bike. The Super Sick Bike is just our prototype for a wider project. Our next step is to get similar bikes around the Metro area.
            </p>
            <p class="text-gray-600 leading-relaxed">
                Eventually, we want to make private transportation available across the country. We will have the bikes stationed around Australia, so you can just hop on and get to your destination easily, without having to pay.
            </p>
        </div>

        <!-- Donation Form -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4">
            <h3 class="text-xl font-semibold text-gray-800">Make a Donation</h3>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <label for="donation-amount" class="sr-only">Donation Amount</label>
                <input type="number" id="donation-amount" min="1" placeholder="Enter amount..." class="flex-1 w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors">
                <button id="donate-button" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                    Donate
                </button>
            </div>
            <div id="message-box" class="text-sm font-medium text-center text-gray-700 mt-2 min-h-[1.5rem]"></div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Import Firebase functions from the SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get references to all necessary DOM elements
        const currentAmountEl = document.getElementById('current-amount');
        const goalAmountEl = document.getElementById('goal-amount');
        const progressBarEl = document.getElementById('progress-bar');
        const totalDonationsEl = document.getElementById('total-donations');
        const donationAmountInput = document.getElementById('donation-amount');
        const donateButton = document.getElementById('donate-button');
        const messageBoxEl = document.getElementById('message-box');

        // Set the campaign goals and constants
        const GOAL_AMOUNT = 5000;
        const MAX_DONATION = 100;

        // Document path in Firestore.
        const donationsRef = doc(db, `/artifacts/${appId}/public/data/donations-data/main-donations`);

        // Asynchronously sign in and then set up the listener
        const initialize = async () => {
            try {
                // Sign in with the custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Initial data for the document if it doesn't exist
                const initialData = { currentAmount: 0, totalDonations: 0 };
                await setDoc(donationsRef, initialData, { merge: true });

                // Set up a real-time listener to update the UI
                onSnapshot(donationsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const currentAmount = data.currentAmount || 0;
                        const totalDonations = data.totalDonations || 0;
                        updateUI(currentAmount, totalDonations);
                    } else {
                        // Document does not exist, initialize it
                        setDoc(donationsRef, initialData);
                    }
                }, (error) => {
                    console.error("Error listening to document:", error);
                    messageBoxEl.textContent = "Error: Could not load donation data.";
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                messageBoxEl.textContent = "Error: Failed to connect to the database.";
            }
        };

        // Function to update the UI with current data from Firestore
        const updateUI = (currentAmount, totalDonations) => {
            currentAmountEl.textContent = `$${currentAmount.toLocaleString()}`;
            goalAmountEl.textContent = `goal of $${GOAL_AMOUNT.toLocaleString()}`;
            const progressPercentage = Math.min((currentAmount / GOAL_AMOUNT) * 100, 100);
            progressBarEl.style.width = `${progressPercentage}%`;
            totalDonationsEl.textContent = totalDonations;
        };

        // Function to handle the donation
        const handleDonate = async () => {
            const donationAmount = parseFloat(donationAmountInput.value);

            // Check for donation limit
            if (donationAmount > MAX_DONATION) {
                messageBoxEl.textContent = `The donation cannot exceed $${MAX_DONATION}.`;
                return;
            }

            // Basic validation
            if (isNaN(donationAmount) || donationAmount <= 0) {
                messageBoxEl.textContent = 'Please enter a valid amount.';
                return;
            }

            // Update the data in Firestore
            try {
                await updateDoc(donationsRef, {
                    currentAmount: increment(donationAmount),
                    totalDonations: increment(1)
                });
                messageBoxEl.textContent = `Thanks for your donation of $${donationAmount.toLocaleString()}!`;
                donationAmountInput.value = '';
            } catch (error) {
                console.error("Error updating document:", error);
                messageBoxEl.textContent = "Error: Failed to process donation.";
            }
        };

        // Attach the click event listener to the donate button
        donateButton.addEventListener('click', handleDonate);

        // Also allow donations by pressing Enter in the input field
        donationAmountInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleDonate();
            }
        });

        // Start the application
        initialize();
    </script>
</body>
</html>

