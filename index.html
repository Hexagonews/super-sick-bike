<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Sick Bike Fundraiser Page</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/KwPfJk7.png">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-gradient-to-b from-yellow-400 via-pink-500 to-blue-400 flex flex-col items-center justify-center p-6 font-sans">
  <div class="w-full max-w-3xl shadow-2xl rounded-3xl border-4 border-yellow-400 bg-white p-10 text-center space-y-6">
    <img src="https://i.imgur.com/clsLfk1.png" alt="SpikePrime Logo" class="mx-auto mb-4 object-contain max-h-52" />

    <h1 class="text-4xl font-extrabold text-pink-600 drop-shadow-lg">Our Mission</h1>
    <p class="text-gray-800 text-lg">
      We are on a mission to raise <span class="font-bold" id="goal-amount">$10,500</span> to support our project. Every contribution brings us closer to achieving our goals, and together we can make an impact.
    </p>
    <p class="text-gray-800 text-lg">
      Our mission began at Rosalie Primary School where we created a prototype for the Super Sick Bike. The Super Sick Bike is just our prototype for a wider project. Our next step is to get similar bikes around the Metro area.
    </p>
    <p class="text-gray-800 text-lg">
      Eventually, we want to make private transportation available across the country. We will have the bikes stationed around Australia, so you can just hop on and get to your destination easily, without having to pay.
    </p>

    <div id="badges" class="flex justify-center gap-4 mt-1 flex-wrap"></div>

    <div class="w-full bg-gray-300 rounded-full h-8 overflow-hidden mt-4 shadow-inner">
      <div id="progress-bar" class="h-8 bg-gradient-to-r from-blue-400 via-pink-500 to-yellow-400 rounded-full" style="width:0%"></div>
    </div>

    <p class="text-lg font-semibold" id="raised-text">Raised: $0 / $10,500</p>

    <div class="space-y-3 text-left">
      <input type="email" id="email" placeholder="Enter your rosaliens.com email" class="w-full border-2 border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-600" />
      <input type="number" id="amount" step="0.01" placeholder="Enter amount (max $100)" class="w-full border-2 border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <button onclick="handleDonate()" class="bg-blue-400 hover:bg-blue-600 text-white rounded-3xl px-8 py-4 text-xl shadow-xl w-full font-bold">Donate</button>
    </div>

    <div id="error-box" class="hidden mt-2 p-3 rounded-xl bg-red-50 text-left border border-red-200 text-red-700 text-sm"></div>

    <h2 class="text-xl font-semibold mb-3 text-pink-600 mt-6">Recent Donors</h2>
    <ul id="donors-list" class="space-y-2 text-gray-700"></ul>

    <button onclick="showFullHistory()" class="mt-4 px-6 py-3 rounded-xl bg-yellow-400 hover:bg-yellow-500 font-bold shadow-md">View Full History</button>
    <ul id="full-history" class="hidden mt-4 space-y-2 text-gray-700 text-sm"></ul>

    <p class="mt-6 text-xs text-gray-500">This is a demo fundraiser page. Donations are not real money.</p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCPDey68EN2kuPEwcIb4x5ldl3hM9ig__w",
      authDomain: "super-sick-bike-fundraiser.firebaseapp.com",
      projectId: "super-sick-bike-fundraiser",
      storageBucket: "super-sick-bike-fundraiser.appspot.com",
      messagingSenderId: "17825933291",
      appId: "1:17825933291:web:310e9a43f0a313a15bdbae"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let goal = 10500;
    let raised = 0;
    let donationLimit = 100;

    function showError(msg) {
      const box = document.getElementById('error-box');
      box.textContent = msg;
      box.classList.remove('hidden');
    }
    function clearError() {
      const box = document.getElementById('error-box');
      box.textContent = '';
      box.classList.add('hidden');
    }
    function toMoney(n) { return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function updateProgress() {
      const pct = Math.max(0, Math.min(100, (raised / goal) * 100));
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('raised-text').textContent = `Raised: $${toMoney(raised)} / $${toMoney(goal)}`;
      document.getElementById('goal-amount').textContent = `$${toMoney(goal)}`;
    }

    function formatNameFromEmail(email) {
      const namePart = email.split('@')[0];
      return namePart.replace(/\./g, ' ');
    }

    function addDonorToList(email, amount) {
      const ul = document.getElementById('donors-list');
      const li = document.createElement('li');
      li.textContent = `${formatNameFromEmail(email)} - $${toMoney(amount)}`;
      ul.insertBefore(li, ul.firstChild);
      while (ul.children.length > 10) ul.removeChild(ul.lastChild);
    }

    auth.signInAnonymously().then(() => {
      console.log('Signed in anonymously');
      loadSettings();
      loadDonors();
    }).catch((err) => {
      console.error('Anonymous auth failed:', err);
      showError('Anonymous sign-in failed. Enable Anonymous Auth in Firebase Console.');
    });

    async function loadSettings() {
      try {
        const doc = await db.collection('config').doc('settings').get();
        if (doc.exists) {
          const data = doc.data();
          goal = data.goal || goal;
          raised = data.raised || raised;
          donationLimit = data.limit || donationLimit;
          updateProgress();
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function loadDonors() {
      clearError();
      try {
        const snap = await db.collection('donors').orderBy('createdAt', 'desc').limit(10).get();
        snap.forEach(doc => {
          const d = doc.data();
          addDonorToList(d.email, Number(d.amount));
        });
      } catch (err) {
        console.error('Error loading donations:', err);
        showError(`Error loading donations: ${err.message}`);
      }
    }

    async function handleDonate() {
      clearError();
      const email = document.getElementById('email').value.trim();
      let amount = parseFloat(document.getElementById('amount').value);
      amount = Math.round(amount * 100) / 100;

      const regex = /^[^@]+@rosaliens\.com$/;
      if (!regex.test(email)) { alert('Invalid email. Use your @rosaliens.com address'); return; }
      if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
      if (amount > donationLimit) { alert(`Maximum donation is $${donationLimit}`); return; }

      try {
        await db.collection('donors').add({
          email,
          amount,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await db.collection('config').doc('settings').update({
          raised: firebase.firestore.FieldValue.increment(amount)
        });

        raised += amount;
        updateProgress();
        addDonorToList(email, amount);
        document.getElementById('amount').value = '';
      } catch (err) {
        console.error('Error saving donation:', err);
        showError(`Error saving donation: ${err.code || ''} ${err.message || err}`);
      }
    }

    async function showFullHistory() {
      const ul = document.getElementById('full-history');
      ul.innerHTML = '';
      try {
        const snap = await db.collection('donors').orderBy('createdAt', 'desc').get();
        snap.forEach(doc => {
          const d = doc.data();
          const li = document.createElement('li');
          li.textContent = `${formatNameFromEmail(d.email)} - $${toMoney(d.amount)}`;
          ul.appendChild(li);
        });
        ul.classList.toggle('hidden');
      } catch (err) {
        console.error('Error loading full history:', err);
      }
    }

    window.handleDonate = handleDonate;
    window.showFullHistory = showFullHistory;
  </script>
</body>
</html>
