<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Super Sick Bike Fundraiser</title>
    <!-- Use Tailwind CSS for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the Inter font for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti library for the "thank you" animation -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom animation for the button pop */
        .donate-pop {
            animation: pop 0.2s ease-in-out;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 relative space-y-8">

    <!-- Main container for the GoFundMe-like page -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden max-w-2xl w-full p-8 space-y-8">

        <!-- User ID display for reference -->
        <div class="text-xs text-gray-400 text-right">User ID: <span id="user-id">Loading...</span></div>

        <!-- Campaign Header -->
        <div class="text-center space-y-4">
            <h1 class="text-4xl font-bold text-gray-800">Help Fund The Super Sick Bike!</h1>
        </div>

        <!-- Campaign Image -->
        <div class="rounded-lg overflow-hidden shadow-lg">
            <!-- User-provided image for the "sick bike" -->
            <img src="https://i.imgur.com/clsLfk1.png" alt="The Super Sick Bike" class="w-full h-auto object-cover">
        </div>

        <!-- Donation Progress Section -->
        <div class="space-y-4">
            <div class="flex justify-between items-center text-lg font-semibold text-gray-700">
                <span id="current-amount">$0</span>
                <span id="goal-amount">goal of $5,000</span>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-yellow-500 h-3 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>

            <div class="text-sm text-gray-500">
                <span id="total-donations">0</span> donations
            </div>
        </div>

        <!-- Campaign Story Section -->
        <div class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Our Mission</h2>
            <p id="story-text" class="text-gray-600 leading-relaxed">
                Our mission began at Rosalie Primary School where we created a prototype for the Super Sick Bike. The Super Sick Bike is just our prototype for a wider project. Our next step is to get similar bikes around the Metro area.
                Eventually, we want to make private transportation available across the country. We will have the bikes stationed around Australia, so you can just hop on and get to your destination easily, without having to pay.
            </p>
        </div>
        
        <!-- New: Gemini-powered Thank You Message Section -->
        <div id="thank-you-section" class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4 hidden">
            <h3 class="text-xl font-semibold text-gray-800">A special thank you to you!</h3>
            <div id="thank-you-message" class="text-gray-600 leading-relaxed italic text-center"></div>
        </div>

        <!-- Donation Form -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4">
            <h3 class="text-xl font-semibold text-gray-800">Make a Donation</h3>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <label for="donation-amount" class="sr-only">Donation Amount</label>
                <input type="number" id="donation-amount" min="1" placeholder="Enter amount..." class="flex-1 w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors">
                <button id="donate-button" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                    Donate
                </button>
            </div>
            <div id="message-box" class="text-sm font-medium text-center text-gray-700 mt-2 min-h-[1.5rem]"></div>
        </div>
    </div>

    <!-- New: My Badges Section - displays a single current badge -->
    <div id="my-badges-section" class="bg-white rounded-xl shadow-2xl overflow-hidden max-w-2xl w-full p-8 space-y-6 hidden">
        <h2 class="text-2xl font-semibold text-gray-800">My Donation Status</h2>
        <div class="space-y-2 text-center">
            <p class="text-lg font-medium text-gray-600">Total Donated: <span id="total-donated-user" class="font-bold text-gray-800">$0</span></p>
            <div class="flex items-center justify-center space-x-2">
                <p class="text-lg font-medium text-gray-600">Current Badge:</p>
                <span id="badge-display" class="bg-yellow-100 text-yellow-800 font-bold text-xl px-4 py-2 rounded-full shadow-md">No Badge Yet</span>
            </div>
        </div>
    </div>

    <!-- Password modal (hidden by default) -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <!-- Themed password box -->
        <div class="bg-white rounded-xl shadow-2xl p-6 w-80 space-y-4">
            <h4 class="text-xl font-semibold text-gray-800 text-center">Enter Password</h4>
            <!-- Themed input field -->
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors text-gray-800">
            <!-- Themed submit button -->
            <button id="password-submit" class="w-full py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors">
                Submit
            </button>
            <!-- Themed exit button -->
            <button id="password-exit-btn" class="w-full py-3 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-gray-400 transition-colors">
                Exit
            </button>
            <div id="password-message" class="text-sm text-center text-red-500 min-h-[1.5rem]"></div>
        </div>
    </div>

    <!-- Developer Controls Panel (hidden by default) -->
    <!-- Themed dev panel -->
    <div id="dev-panel" class="fixed bottom-4 right-4 w-96 bg-white rounded-xl shadow-2xl p-8 space-y-4 hidden z-50 text-gray-800">
        <h4 class="text-lg font-semibold border-b border-gray-300 pb-2">Developer Controls</h4>
        <div class="space-y-2">
            <label for="dev-target" class="block text-sm text-gray-600">Change Goal ($):</label>
            <!-- Themed input field -->
            <input type="number" id="dev-target" placeholder="New Goal" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors text-gray-800">
            <!-- Themed button -->
            <button id="dev-set-target" class="w-full py-3 bg-purple-500 text-white font-bold rounded-lg shadow-lg hover:bg-purple-600 transition-colors">Set Goal</button>
        </div>
        <div class="space-y-2">
            <label for="dev-amount" class="block text-sm text-gray-600">Change Amount ($):</label>
            <!-- Themed input field -->
            <input type="number" id="dev-amount" placeholder="New Amount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors text-gray-800">
            <!-- Themed button -->
            <button id="dev-set-amount" class="w-full py-3 bg-purple-500 text-white font-bold rounded-lg shadow-lg hover:bg-purple-600 transition-colors">Set Amount</button>
        </div>
        <!-- NEW: Max Donation Amount Control -->
        <div class="space-y-2">
            <label for="dev-max-donation" class="block text-sm text-gray-600">Change Max Donation ($):</label>
            <input type="number" id="dev-max-donation" placeholder="New Max Amount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors text-gray-800">
            <button id="dev-set-max-donation" class="w-full py-3 bg-purple-500 text-white font-bold rounded-lg shadow-lg hover:bg-purple-600 transition-colors">Set Max</button>
        </div>
        <!-- Themed button -->
        <button id="dev-reset" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors">Reset Everything</button>
    </div>

    <!-- Developer Icon to toggle the panel -->
    <button id="dev-toggle" class="fixed bottom-4 left-4 text-3xl text-gray-800 opacity-20 hover:opacity-100 transition-opacity z-50">
        ‚öôÔ∏è
    </button>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Firebase configuration and other constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        const DEFAULT_GOAL = 5000;
        const DEFAULT_MAX_DONATION_AMOUNT = 100;
        const PASSWORD = 'InTheShadow';
        let db, auth, userId;

        // Function to update the UI with current data
        const updateUI = (currentAmount, totalDonations, goalAmount) => {
            const currentAmountEl = document.getElementById('current-amount');
            const goalAmountEl = document.getElementById('goal-amount');
            const progressBarEl = document.getElementById('progress-bar');
            const totalDonationsEl = document.getElementById('total-donations');
            
            currentAmountEl.textContent = `$${currentAmount.toLocaleString()}`;
            goalAmountEl.textContent = `goal of $${goalAmount.toLocaleString()}`;
            const progressPercentage = Math.min((currentAmount / goalAmount) * 100, 100);
            progressBarEl.style.width = `${progressPercentage}%`;
            totalDonationsEl.textContent = totalDonations;
        };

        // Function to update the user's personal donation status UI
        const updateUserUI = (totalDonated, badgeName) => {
            const myBadgesSection = document.getElementById('my-badges-section');
            const totalDonatedUserEl = document.getElementById('total-donated-user');
            const badgeDisplayEl = document.getElementById('badge-display');

            // Show the section if a user has donated, otherwise hide it
            if (totalDonated > 0) {
                myBadgesSection.classList.remove('hidden');
                totalDonatedUserEl.textContent = `$${totalDonated.toLocaleString()}`;
                badgeDisplayEl.textContent = badgeName;
            } else {
                myBadgesSection.classList.add('hidden');
            }
        };

        // Function to determine the badge based on total accumulated donation amount
        const getBadgeForDonation = (totalAmount) => {
            if (totalAmount >= 500) {
                return "Bike Legend üëë";
            } else if (totalAmount >= 200) {
                return "Road King üö¥‚Äç‚ôÇÔ∏è";
            } else if (totalAmount >= 100) {
                return "Bike Champion üèÜ";
            } else if (totalAmount >= 50) {
                return "Spoke Master ‚öôÔ∏è";
            } else if (totalAmount >= 20) {
                return "Frame Builder üõ†Ô∏è";
            } else if (totalAmount >= 10) {
                return "Chain Linker üîó";
            } else {
                return "Wheel Spinner üí®";
            }
        };

        // Function to handle the text generation API call
        const handleGenerateThanks = async () => {
            const thankYouMessageEl = document.getElementById('thank-you-section');
            thankYouMessageEl.textContent = 'Generating your personalized message...';
            
            const prompt = "Write a short, fun, and heartfelt thank you message for someone who just donated to a bike fundraiser. Make it sound like it's from a person who loves bikes.";
            
            const payload = { 
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (generatedText) {
                    thankYouMessageEl.textContent = generatedText;
                } else {
                    thankYouMessageEl.textContent = 'Sorry, could not generate a message right now. Please try again!';
                }
            } catch (e) {
                console.error("Error generating text:", e);
                thankYouMessageEl.textContent = `Error: ${e.message}`;
            }
        };

        // Wait for the window to load before starting
        window.onload = async function() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing.");
                document.getElementById('message-box').textContent = "Error: Firebase configuration is missing.";
                return;
            }

            // Initialize Firebase app and services
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Get references to DOM elements
            const thankYouSection = document.getElementById('thank-you-section');
            const donationAmountInput = document.getElementById('donation-amount');
            const donateButton = document.getElementById('donate-button');
            const messageBoxEl = document.getElementById('message-box');

            // Get references to dev controls and password modal
            const devToggle = document.getElementById('dev-toggle');
            const devPanel = document.getElementById('dev-panel');
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmitBtn = document.getElementById('password-submit');
            const passwordExitBtn = document.getElementById('password-exit-btn');
            const passwordMessageEl = document.getElementById('password-message');
            const devTargetInput = document.getElementById('dev-target');
            const devSetTargetBtn = document.getElementById('dev-set-target');
            const devAmountInput = document.getElementById('dev-amount');
            const devSetAmountBtn = document.getElementById('dev-set-amount');
            const devResetBtn = document.getElementById('dev-reset');
            const devMaxDonationInput = document.getElementById('dev-max-donation');
            const devSetMaxDonationBtn = document.getElementById('dev-set-max-donation');

            // Toggle dev panel visibility with a single click.
            devToggle.addEventListener('click', () => {
                if (!devPanel.classList.contains('hidden')) {
                    devPanel.classList.add('hidden');
                } else {
                    passwordModal.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordMessageEl.textContent = '';
                    passwordInput.focus();
                }
            });

            // Handle password submission
            const handlePasswordSubmit = () => {
                if (passwordInput.value === PASSWORD) {
                    passwordModal.classList.add('hidden');
                    devPanel.classList.remove('hidden');
                } else {
                    passwordMessageEl.textContent = 'Incorrect password.';
                }
            };
            passwordSubmitBtn.addEventListener('click', handlePasswordSubmit);
            passwordInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handlePasswordSubmit();
                }
            });

            // Handle the exit button for the password modal
            passwordExitBtn.addEventListener('click', () => {
                passwordModal.classList.add('hidden');
            });

            // Authenticate the user
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                messageBoxEl.textContent = "Error: Authentication failed. Data may not be saved.";
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;

                    // Document reference for main fundraiser data
                    const mainDocRef = doc(db, `artifacts/${appId}/public/data/donations`, "summary");
                    
                    // Document reference for the current user's personal donation summary
                    const userSummaryDocRef = doc(db, `artifacts/${appId}/users/${userId}/summary`, "donations");

                    // Set up a real-time listener for the main document
                    onSnapshot(mainDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            updateUI(
                                data.currentAmount || 0,
                                data.totalDonations || 0,
                                data.goalAmount || DEFAULT_GOAL
                            );
                            devTargetInput.value = data.goalAmount || DEFAULT_GOAL;
                            devAmountInput.value = data.currentAmount || 0;
                            devMaxDonationInput.value = data.maxDonationAmount || DEFAULT_MAX_DONATION_AMOUNT;
                        } else {
                            updateUI(0, 0, DEFAULT_GOAL);
                            try {
                                setDoc(mainDocRef, { 
                                    currentAmount: 0, 
                                    totalDonations: 0,
                                    goalAmount: DEFAULT_GOAL,
                                    maxDonationAmount: DEFAULT_MAX_DONATION_AMOUNT
                                });
                            } catch (e) {
                                console.error("Error creating initial document:", e);
                            }
                        }
                    }, (error) => {
                        console.error("Error listening to main document:", error);
                        messageBoxEl.textContent = "Error: Could not load data.";
                    });

                    // Set up a real-time listener for the user's donation summary
                    onSnapshot(userSummaryDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            updateUserUI(data.totalDonated || 0, data.currentBadgeName || "No Badge Yet");
                        } else {
                            // Document doesn't exist, initialize it with a default badge
                            updateUserUI(0, "No Badge Yet");
                            try {
                                setDoc(userSummaryDocRef, { 
                                    totalDonated: 0,
                                    currentBadgeName: "No Badge Yet"
                                });
                            } catch (e) {
                                console.error("Error creating user summary document:", e);
                            }
                        }
                    }, (error) => {
                        console.error("Error listening to user summary:", error);
                    });

                    // Function to handle the donation
                    const handleDonate = async () => {
                        const donationAmount = parseFloat(donationAmountInput.value);

                        const mainDocSnap = await getDoc(mainDocRef);
                        const mainData = mainDocSnap.data();
                        const maxDonationAmount = mainData.maxDonationAmount || DEFAULT_MAX_DONATION_AMOUNT;

                        if (isNaN(donationAmount) || donationAmount <= 0) {
                            messageBoxEl.textContent = 'Please enter a valid amount.';
                            return;
                        }

                        if (donationAmount > maxDonationAmount) {
                            // Use the correct message for the default limit
                            const message = `The donation cannot exceed $${maxDonationAmount}`;
                            messageBoxEl.textContent = message;
                            return;
                        }

                        donateButton.classList.add('donate-pop');
                        setTimeout(() => {
                            donateButton.classList.remove('donate-pop');
                        }, 200);

                        messageBoxEl.textContent = 'Donating...';
                        
                        try {
                            // Update the main public fundraiser document
                            const newAmount = (mainData.currentAmount || 0) + donationAmount;
                            const newDonations = (mainData.totalDonations || 0) + 1;
                            await setDoc(mainDocRef, {
                                currentAmount: newAmount,
                                totalDonations: newDonations,
                            }, { merge: true });

                            // Update the user's personal donation summary document
                            const userSummaryDocSnap = await getDoc(userSummaryDocRef);
                            const userSummaryData = userSummaryDocSnap.data();
                            const newTotalDonated = (userSummaryData.totalDonated || 0) + donationAmount;
                            const newBadgeName = getBadgeForDonation(newTotalDonated);
                            
                            await setDoc(userSummaryDocRef, {
                                totalDonated: newTotalDonated,
                                currentBadgeName: newBadgeName,
                                lastDonationTimestamp: Date.now()
                            }, { merge: true });

                            messageBoxEl.textContent = `Thanks for your donation of $${donationAmount.toLocaleString()}!`;
                            
                            thankYouSection.classList.remove('hidden');

                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 }
                            });

                            handleGenerateThanks();
                            
                            donationAmountInput.value = '';
                        } catch (e) {
                            console.error("Error adding donation: ", e);
                            messageBoxEl.textContent = "Error: Donation failed. Please try again.";
                        }
                    };

                    donateButton.addEventListener('click', handleDonate);
                    donationAmountInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            handleDonate();
                        }
                    });

                    // --- Developer Controls Logic ---
                    devSetTargetBtn.addEventListener('click', async () => {
                        const newGoal = parseFloat(devTargetInput.value);
                        if (isNaN(newGoal) || newGoal <= 0) {
                            messageBoxEl.textContent = 'Please enter a valid goal amount.';
                            return;
                        }
                        try {
                            await setDoc(mainDocRef, { goalAmount: newGoal }, { merge: true });
                            messageBoxEl.textContent = `Goal successfully updated to $${newGoal.toLocaleString()}`;
                        } catch (e) {
                            console.error("Error setting new goal:", e);
                            messageBoxEl.textContent = "Error setting new goal. Please try again.";
                        }
                    });

                    devSetAmountBtn.addEventListener('click', async () => {
                        const newAmount = parseFloat(devAmountInput.value);
                        if (isNaN(newAmount) || newAmount < 0) {
                            messageBoxEl.textContent = 'Please enter a valid amount.';
                            return;
                        }
                        try {
                            await setDoc(mainDocRef, { currentAmount: newAmount, totalDonations: 0 }, { merge: true });
                            messageBoxEl.textContent = `Donation amount successfully updated to $${newAmount.toLocaleString()}`;
                        } catch (e) {
                            console.error("Error setting new amount:", e);
                            messageBoxEl.textContent = "Error setting new amount. Please try again.";
                        }
                    });

                    devSetMaxDonationBtn.addEventListener('click', async () => {
                        const newMaxDonation = parseFloat(devMaxDonationInput.value);
                        if (isNaN(newMaxDonation) || newMaxDonation < 0) {
                            messageBoxEl.textContent = 'Please enter a valid maximum amount.';
                            return;
                        }
                        try {
                            await setDoc(mainDocRef, { maxDonationAmount: newMaxDonation }, { merge: true });
                            messageBoxEl.textContent = `Maximum donation amount successfully updated to $${newMaxDonation.toLocaleString()}`;
                        } catch (e) {
                            console.error("Error setting new max donation:", e);
                            messageBoxEl.textContent = "Error setting new max donation. Please try again.";
                        }
                    });

                    devResetBtn.addEventListener('click', async () => {
                        try {
                            await setDoc(mainDocRef, { currentAmount: 0, totalDonations: 0 }, { merge: true });
                            // Also reset user's personal data
                            await setDoc(userSummaryDocRef, { totalDonated: 0, currentBadgeName: "No Badge Yet" }, { merge: true });
                            messageBoxEl.textContent = "All data has been reset.";
                        } catch (e) {
                            console.error("Error resetting data:", e);
                            messageBoxEl.textContent = "Error resetting data. Please try again.";
                        }
                    });
                }
            });

            // Initial UI update for loading state
            updateUI(0, 0, DEFAULT_GOAL);
            updateUserUI(0, "No Badge Yet");
        };
    </script>
</body>
</html>
