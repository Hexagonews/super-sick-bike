<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Super Sick Bike Fundraiser</title>
    <!-- Use Tailwind CSS for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the Inter font for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom CSS for modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Custom CSS for badge gradients and animations */
        .badge-base {
            display: inline-flex;
            align-items: center;
            gap: 8px; /* Equivalent of tailwind space-x-2 */
            padding: 4px 12px; /* Equivalent of tailwind px-3 py-1 */
            border-radius: 9999px; /* Equivalent of tailwind rounded-full */
            font-size: 0.875rem; /* Equivalent of tailwind text-sm */
            font-weight: 600; /* Equivalent of tailwind font-semibold */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }

        .badge-base:hover {
            transform: translateY(-2px);
        }

        .badge-seedling {
            background: linear-gradient(135deg, #22C55E, #84cc16); /* green-500 to lime-500 */
            color: #1f2937; /* gray-800 */
        }
        .badge-bronze {
            background: linear-gradient(135deg, #CD7F32, #A86018); /* custom bronze */
            color: #1f2937;
        }
        .badge-silver {
            background: linear-gradient(135deg, #C0C0C0, #A9A9A9); /* custom silver */
            color: #1f2937;
        }
        .badge-golden {
            background: linear-gradient(135deg, #FFD700, #F5B800); /* gold */
            color: #1f2937;
        }
        .badge-hero {
            background: linear-gradient(135deg, #F9A8D4, #F472B6); /* pink */
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Settings Icon -->
    <button id="settings-button" class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors z-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
    
    <!-- Main container for the GoFundMe-like page -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden max-w-2xl w-full p-8 space-y-8 z-10">

        <!-- Campaign Header -->
        <div class="text-center space-y-4">
            <h1 class="text-4xl font-bold text-gray-800">Help Fund The Super Sick Bike!</h1>
        </div>

        <!-- Campaign Image -->
        <div class="rounded-lg overflow-hidden shadow-lg">
            <!-- Updated image URL from the user's provided link -->
            <img src="https://i.imgur.com/clsLfk1.png" alt="The Super Sick Bike" class="w-full h-auto object-cover">
        </div>

        <!-- Donation Progress Section -->
        <div class="space-y-4">
            <div class="flex justify-between items-center text-lg font-semibold text-gray-700">
                <span id="current-amount">$0</span>
                <span id="goal-amount">goal of $5,000</span>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-yellow-500 h-3 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>

            <div class="text-sm text-gray-500">
                <span id="total-donations">0</span> donations
            </div>
            
            <!-- Badges Section - NEW -->
            <div id="badge-container" class="flex justify-center items-center h-16">
                <!-- Badges will be dynamically added here -->
            </div>
        </div>

        <!-- Campaign Story Section -->
        <div class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Our Mission</h2>
            <p class="text-gray-600 leading-relaxed">
                Our mission began at Rosalie Primary School where we created a prototype for the Super Sick Bike. The Super Sick Bike is just our prototype for a wider project. Our next step is to get similar bikes around the Metro area.
            </p>
            <p class="text-gray-600 leading-relaxed">
                Eventually, we want to make private transportation available across the country. We will have the bikes stationed around Australia, so you can just hop on and get to your destination easily, without having to pay.
            </p>
        </div>

        <!-- Donation Form -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4">
            <h3 class="text-xl font-semibold text-gray-800">Make a Donation</h3>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <label for="donation-amount" class="sr-only">Donation Amount</label>
                <input type="number" id="donation-amount" min="1" placeholder="Enter amount..." class="flex-1 w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors">
                <button id="donate-button" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                    Donate
                </button>
            </div>
            <div id="message-box" class="text-sm font-medium text-center text-gray-700 mt-2 min-h-[1.5rem]"></div>
        </div>

    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 modal-backdrop z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 space-y-6 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Enter Password</h2>
            <div class="space-y-4">
                <label for="password-input" class="sr-only">Password</label>
                <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
            </div>
            <button id="password-enter-button" class="w-full px-6 py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                Enter
            </button>
            <button id="password-close-button" class="w-full text-sm text-gray-500 hover:text-gray-700 transition-colors">
                Cancel
            </button>
            <div id="password-message-box" class="text-sm font-medium text-center text-red-500 mt-2 min-h-[1.5rem]"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 modal-backdrop z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 space-y-6 w-full max-w-md">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Campaign Settings</h2>
                <button id="close-settings-button" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="goal-input" class="block text-sm font-medium text-gray-700 mb-2">Donation Goal</label>
                    <input type="number" id="goal-input" min="1" placeholder="e.g., 10000" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label for="current-amount-input" class="block text-sm font-medium text-gray-700 mb-2">Current Amount</label>
                    <input type="number" id="current-amount-input" min="0" placeholder="e.g., 500" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label for="max-donation-input" class="block text-sm font-medium text-gray-700 mb-2">Max Donation Limit</label>
                    <input type="number" id="max-donation-input" min="1" placeholder="e.g., 100" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>

            <button id="save-settings-button" class="w-full px-6 py-3 bg-yellow-500 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                Save Settings
            </button>
            <div id="settings-message-box" class="text-sm font-medium text-center text-gray-700 mt-2 min-h-[1.5rem]"></div>
        </div>
    </div>


    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the global variables provided by the Canvas environment.
        // DO NOT use a hardcoded Firebase configuration.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // A simple way to get a unique user ID for anonymous sessions.
        let userId;

        // Get references to all necessary DOM elements
        const currentAmountEl = document.getElementById('current-amount');
        const goalAmountEl = document.getElementById('goal-amount');
        const progressBarEl = document.getElementById('progress-bar');
        const totalDonationsEl = document.getElementById('total-donations');
        const donationAmountInput = document.getElementById('donation-amount');
        const donateButton = document.getElementById('donate-button');
        const messageBoxEl = document.getElementById('message-box');
        
        // Elements for the password modal
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordEnterButton = document.getElementById('password-enter-button');
        const passwordCloseButton = document.getElementById('password-close-button');
        const passwordMessageBox = document.getElementById('password-message-box');
        
        // Elements for the settings modal
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings-button');
        const goalInput = document.getElementById('goal-input');
        const currentAmountInput = document.getElementById('current-amount-input');
        const maxDonationInput = document.getElementById('max-donation-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const settingsMessageBox = document.getElementById('settings-message-box');

        // Badge container element
        const badgeContainerEl = document.getElementById('badge-container');

        // Let variables for dynamic campaign constants
        let GOAL_AMOUNT;
        let MAX_DONATION;
        
        const SETTINGS_PASSWORD = 'InTheShadow';
        // Document path for public campaign data
        const publicDonationsRef = doc(db, `/artifacts/${appId}/public/data/donations-data/main-donations`);

        // Function to update the badges based on an amount
        const updateBadges = (amount) => {
            let badgeHtml = '';
            
            // Generate the correct badge based on the amount
            if (amount >= 2500) {
                // Golden Giver Badge
                badgeHtml = `<div class="badge-base badge-golden">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M10.788 3.21c.439-1.077 1.902-1.077 2.34 0a1.5 1.5 0 01.768.18l2.96-.983a1.5 1.5 0 011.85 1.85l-.983 2.961a1.5 1.5 0 01.18.769c1.078.439 1.078 1.902 0 2.34a1.5 1.5 0 01-.18.768l.983 2.96c.394 1.187-.827 2.39-2.014 2.014l-2.96-.983a1.5 1.5 0 01-.768.18c-1.077.439-1.077 1.902 0 2.34a1.5 1.5 0 01.18.768l-.983 2.961c-.394 1.187-1.597 1.39-2.014 1.39V21a1.5 1.5 0 01-2.014-2.014l-.983-2.96a1.5 1.5 0 01-.768-.18c-1.077-.439-1.077-1.902 0-2.34a1.5 1.5 0 01.18-.768l-.983-2.96c-.394-1.187.827-2.39 2.014-2.014l2.96.983a1.5 1.5 0 01.768-.18z" clip-rule="evenodd" />
                                </svg>
                                <span>Golden Giver</span>
                            </div>`;
            } else if (amount >= 1000) {
                // Silver Sponsor Badge
                badgeHtml = `<div class="badge-base badge-silver">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v.258a3 3 0 00-.735 0L12 3.25V3a.75.75 0 01.75-.75zM11.25 7.5a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5zM9.603 16.28a.75.75 0 00-.457-1.12l-.934-.356A3 3 0 004.817 14.5l-.337.094a.75.75 0 00-.414.922l.531 1.062a.75.75 0 00.922.414l.094-.033a3 3 0 00.584.062l.356-.093a.75.75 0 00.414-.922zM12 2.25a.75.75 0 01.75.75v.258a3 3 0 00-.735 0L12 3.25V3a.75.75 0 01.75-.75zM11.25 7.5a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5zM9.603 16.28a.75.75 0 00-.457-1.12l-.934-.356A3 3 0 004.817 14.5l-.337.094a.75.75 0 00-.414.922l.531 1.062a.75.75 0 00.922.414l.094-.033a3 3 0 00.584.062l.356-.093a.75.75 0 00.414-.922zM15.397 16.28a.75.75 0 00-.414.922l.53 1.062a.75.75 0 00.922.414l.095-.034a3 3 0 00.584.062l.356-.093a.75.75 0 00.414-.922l-.53-1.062a.75.75 0 00-.922-.414l-.094.033a3 3 0 00-.584-.062l-.356.093zM12 18.75a.75.75 0 00-.75.75v.258c0 .241.018.481.053.719L11.25 21a.75.75 0 001.5 0l-.053-.719c.035-.238.053-.478.053-.719v-.258a.75.75 0 00-.75-.75zM6.75 20.25a.75.75 0 01-.75-.75V19.5a3 3 0 00-.785-2.028l-.133-.166a.75.75 0 01.996-1.196l.166.133c.277.22.56.438.85.654A.75.75 0 017 17.585v.165a.75.75 0 01-.25.565.75.75 0 01-.5.185zM18.75 20.25a.75.75 0 01-.5-.185.75.75 0 01-.25-.565v-.165a.75.75 0 01.277-.577c.29-.216.573-.434.85-.654l.166-.133a.75.75 0 01.996 1.196l-.133.166A3 3 0 0019.5 19.5v.75a.75.75 0 01-.75.75zM12.75 3a.75.75 0 01.75.75v.258a3 3 0 00-.735 0L12 3.25V3a.75.75 0 01.75-.75zM15.397 16.28a.75.75 0 00-.414.922l.53 1.062a.75.75 0 00.922.414l.095-.034a3 3 0 00.584.062l.356-.093a.75.75 0 00.414-.922l-.53-1.062a.75.75 0 00-.922-.414l-.094.033a3 3 0 00-.584-.062l-.356.093zM12 18.75a.75.75 0 00-.75.75v.258c0 .241.018.481.053.719L11.25 21a.75.75 0 001.5 0l-.053-.719c.035-.238.053-.478.053-.719v-.258a.75.75 0 00-.75-.75zM6.75 20.25a.75.75 0 01-.75-.75V19.5a3 3 0 00-.785-2.028l-.133-.166a.75.75 0 01.996-1.196l.166.133c.277.22.56.438.85.654A.75.75 0 017 17.585v.165a.75.75 0 01-.25.565.75.75 0 01-.5.185zM18.75 20.25a.75.75 0 01-.5-.185.75.75 0 01-.25-.565v-.165a.75.75 0 01.277-.577c.29-.216.573-.434.85-.654l.166-.133a.75.75 0 01.996 1.196l-.133.166A3 3 0 0019.5 19.5v.75a.75.75 0 01-.75.75z" clip-rule="evenodd" />
                                </svg>
                                <span>Silver Sponsor</span>
                            </div>`;
            } else if (amount >= 100) {
                // Bronze Donor Badge
                badgeHtml = `<div class="badge-base badge-bronze">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M12 14.25a.75.75 0 00-.75.75v3.635a.75.75 0 001.5 0V15a.75.75 0 00-.75-.75zM5.318 16.923a.75.75 0 00-.472 1.256l.824.789a.75.75 0 001.256-.472l-.824-.79a.75.75 0 00-.534-.983zM18.84 17.309a.75.75 0 00-1.256-.472l-.824.789a.75.75 0 00.472 1.256l.824-.789a.75.75 0 00.784-.784zM7.701 4.793a.75.75 0 00-1.04-.216L4.17 5.922a.75.75 0 00.216 1.04l2.491-1.144a.75.75 0 00-.177-1.025zM19.829 5.922a.75.75 0 00.216-1.04l-2.491-1.144a.75.75 0 00-1.04.216l2.491 1.144zM12.75 3a.75.75 0 00-1.5 0v.27a.75.75 0 001.5 0V3zM3 13.5a.75.75 0 000 1.5h.375a.75.75 0 000-1.5H3zM20.625 15a.75.75 0 000-1.5h-.375a.75.75 0 000 1.5h.375zM12 7.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9z" clip-rule="evenodd" />
                                </svg>
                                <span>Bronze Donor</span>
                            </div>`;
            } else if (amount >= 50) {
                // Seedling Supporter Badge
                badgeHtml = `<div class="badge-base badge-seedling">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path d="M7.5 18.75a.75.75 0 000 1.5h9a.75.75 0 000-1.5h-9zM6 16.5a.75.75 0 00-.75.75v1.5c0 .414.336.75.75.75h12a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75H6z" />
                                    <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v3.815a1.5 1.5 0 00.866 1.342l1.378.89a.75.75 0 01-.866 1.29l-1.378-.89a3 3 0 01-1.732 0l-1.378.89a.75.75 0 01-.866-1.29l1.378-.89a1.5 1.5 0 00.866-1.342V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                                </svg>
                                <span>Seedling Supporter</span>
                             </div>`;
            } else {
                badgeHtml = ''; // No badge if amount is too low
            }
            
            badgeContainerEl.innerHTML = badgeHtml;
        };

        // Function to update the public UI with current data from Firestore
        const updatePublicUI = (currentAmount, totalDonations, goalAmount) => {
            currentAmountEl.textContent = `$${currentAmount.toLocaleString()}`;
            goalAmountEl.textContent = `goal of $${goalAmount.toLocaleString()}`;
            const progressPercentage = Math.min((currentAmount / goalAmount) * 100, 100);
            progressBarEl.style.width = `${progressPercentage}%`;
            totalDonationsEl.textContent = totalDonations;
        };
        
        // Function to handle the donation
        const handleDonate = async () => {
            const donationAmount = parseFloat(donationAmountInput.value);

            // Check for donation limit
            if (donationAmount > MAX_DONATION) {
                messageBoxEl.textContent = `The donation cannot exceed $${MAX_DONATION}.`;
                return;
            }

            // Basic validation
            if (isNaN(donationAmount) || donationAmount <= 0) {
                messageBoxEl.textContent = 'Please enter a valid amount.';
                return;
            }

            // Update the data in Firestore
            try {
                // Update the public campaign total
                await updateDoc(publicDonationsRef, {
                    currentAmount: increment(donationAmount),
                    totalDonations: increment(1)
                });

                // Update the user's personal donation total
                const personalDonationsRef = doc(db, `/artifacts/${appId}/users/${userId}/personal-donations/my-donation-data`);
                await updateDoc(personalDonationsRef, {
                    myTotalDonated: increment(donationAmount)
                });

                messageBoxEl.textContent = `Thanks for your donation of $${donationAmount.toLocaleString()}!`;
                donationAmountInput.value = '';
            } catch (error) {
                console.error("Error updating document:", error);
                messageBoxEl.textContent = "Error: Failed to process donation.";
            }
        };

        // Function to handle saving settings
        const handleSaveSettings = async () => {
            const newGoal = parseFloat(goalInput.value);
            const newCurrentAmount = parseFloat(currentAmountInput.value);
            const newMaxDonation = parseFloat(maxDonationInput.value);

            // Validation for new goal
            if (isNaN(newGoal) || newGoal <= 0) {
                settingsMessageBox.textContent = 'Please enter a valid goal amount.';
                return;
            }

            // Validation for new current amount
            if (isNaN(newCurrentAmount) || newCurrentAmount < 0) {
                settingsMessageBox.textContent = 'Please enter a valid current amount.';
                return;
            }

            // Validation for max donation limit
            if (isNaN(newMaxDonation) || newMaxDonation < 1) {
                settingsMessageBox.textContent = 'Please enter a valid maximum donation limit.';
                return;
            }

            settingsMessageBox.textContent = 'Saving...';
            try {
                await setDoc(publicDonationsRef, {
                    goalAmount: newGoal,
                    currentAmount: newCurrentAmount,
                    maxDonation: newMaxDonation
                }, { merge: true });
                settingsMessageBox.textContent = 'Settings saved successfully!';
                settingsModal.classList.add('hidden'); // Close modal on success
                // Clear inputs and message after successful save
                goalInput.value = '';
                currentAmountInput.value = '';
                maxDonationInput.value = '';
                settingsMessageBox.textContent = '';
            } catch (error) {
                console.error("Error saving settings:", error);
                settingsMessageBox.textContent = "Error: Failed to save settings.";
            }
        };
        
        // Function to handle password validation
        const handlePasswordCheck = () => {
            if (passwordInput.value === SETTINGS_PASSWORD) {
                passwordModal.classList.add('hidden');
                settingsModal.classList.remove('hidden');
                passwordMessageBox.textContent = ''; // Clear message on success
                passwordInput.value = ''; // Clear password input
            } else {
                passwordMessageBox.textContent = 'Incorrect password. Please try again.';
            }
        };
        
        // Asynchronously sign in and then set up the listener
        const initialize = async () => {
            try {
                // Sign in using the custom token provided by the environment
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Now that we are authenticated, set up the listeners
                // and get the user ID from the authentication state.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;

                        // Document path for user's personal donation data
                        const personalDonationsRef = doc(db, `/artifacts/${appId}/users/${userId}/personal-donations/my-donation-data`);
                        
                        // Initial data for public campaign document if it doesn't exist
                        const publicInitialData = { currentAmount: 0, totalDonations: 0, goalAmount: 5000, maxDonation: 100 };
                        await setDoc(publicDonationsRef, publicInitialData, { merge: true });

                        // Initial data for personal document if it doesn't exist
                        const personalInitialData = { myTotalDonated: 0 };
                        await setDoc(personalDonationsRef, personalInitialData, { merge: true });

                        // Set up a real-time listener for public data
                        onSnapshot(publicDonationsRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const currentAmount = data.currentAmount || 0;
                                const totalDonations = data.totalDonations || 0;
                                GOAL_AMOUNT = data.goalAmount || 5000;
                                MAX_DONATION = data.maxDonation || 100;
                                updatePublicUI(currentAmount, totalDonations, GOAL_AMOUNT);
                            } else {
                                setDoc(publicDonationsRef, publicInitialData);
                            }
                        }, (error) => {
                            console.error("Error listening to public document:", error);
                        });

                        // Set up a real-time listener for personal data
                        onSnapshot(personalDonationsRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const myTotalDonated = data.myTotalDonated || 0;
                                updateBadges(myTotalDonated);
                            } else {
                                setDoc(personalDonationsRef, personalInitialData);
                            }
                        }, (error) => {
                            console.error("Error listening to personal document:", error);
                        });
                    } else {
                        console.log("No user is signed in.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                messageBoxEl.textContent = "Error: Failed to connect to the database. Please check your Firebase config and security rules.";
            }
        };

        // Event listeners for the donation button
        donateButton.addEventListener('click', handleDonate);
        donationAmountInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleDonate();
            }
        });

        // Event listeners for the settings modals
        settingsButton.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });
        passwordEnterButton.addEventListener('click', handlePasswordCheck);
        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handlePasswordCheck();
            }
        });
        passwordCloseButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
            passwordMessageBox.textContent = '';
        });
        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsMessageBox.textContent = '';
        });
        saveSettingsButton.addEventListener('click', handleSaveSettings);

        // Start the application
        initialize();
    </script>
</body>
</html>
